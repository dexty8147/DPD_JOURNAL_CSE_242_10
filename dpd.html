<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPD Solutions E-commerce Platform</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; 
        }
        .primary-blue { background-color: #2874F0; } 
        .primary-orange { background-color: #FF9900; } 
        .accent-green { background-color: #008000; } 
        .text-primary-blue { color: #2874F0; }
        .hover\:bg-primary-blue:hover { background-color: #2465d8; }
        .hover\:bg-accent-green:hover { background-color: #006600; }

        @media print {
            body > *:not(#app) { display: none; }
            #app { display: block !important; margin: 0; padding: 0; }
            #app > *:not(#invoiceView) { display: none; }
            .no-print { display: none !important; }
            #invoiceView {
                box-shadow: none !important;
                border: none !important;
                min-height: 100vh;
                margin: 0;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- The root element for the entire application -->
    <div id="app" class="flex-grow flex flex-col items-center justify-center min-h-screen">
        <div class="p-4 primary-blue rounded-lg shadow-lg text-white">
            <div class="flex items-center space-x-2">
                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Initializing DPD Solutions App...</span>
            </div>
        </div>
    </div>

    <!-- Message Box (Custom Alert) -->
    <div id="messageBox" class="fixed bottom-4 right-4 text-white p-4 rounded-lg shadow-xl hidden transition-opacity duration-300 z-50">
        Message shown here.
    </div>


    <!-- Firebase SDK Imports and Application Logic -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, onSnapshot, runTransaction, setDoc, collection, query, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug');

        
        class AppManager {
            constructor(appId, firebaseConfig, initialAuthToken) {
                this.appId = appId;
                this.MAX_QTY = 10;
                this.isPersistent = false; 

                // Currency Data (Base is USD)
                this.CURRENCIES = {
                    USD: { symbol: '$', rate: 1.00, name: 'US Dollar' },
                    EUR: { symbol: '€', rate: 0.92, name: 'Euro' },
                    GBP: { symbol: '£', rate: 0.79, name: 'British Pound' },
                    INR: { symbol: '₹', rate: 83.50, name: 'Indian Rupee' },
                };
                
                this.state = {
                    isAuthReady: false,
                    userId: null,
                    currentView: 'signIn', 
                    selectedCurrency: 'USD',
                    products: [
                        { id: 'p1', name: 'Vintage T-Shirt', price: 9.00, img: 'https://placehold.co/150x150/2874F0/ffffff?text=T-Shirt' },
                        { id: 'p2', name: 'Minimalist Mug', price: 10.50, img: 'https://placehold.co/150x150/008000/ffffff?text=Mug' },
                        { id: 'p3', name: 'Leather Wallet', price: 15.00, img: 'https://placehold.co/150x150/FF9900/ffffff?text=Wallet' },
                        { id: 'p4', name: 'Canvas Tote Bag', price: 18.00, img: 'https://placehold.co/150x150/5B00B2/ffffff?text=Bag' },
                        { id: 'p5', name: 'Noise Cancelling Headphones', price: 199.99, img: 'https://placehold.co/150x150/000000/ffffff?text=Headphones' },
                        { id: 'p6', name: 'Portable Power Bank', price: 20.99, img: 'https://placehold.co/150x150/FF4500/ffffff?text=Power+Bank' },
                        { id: 'p7', name: 'Smart Watch X9', price: 12.00, img: 'https://placehold.co/150x150/6A5ACD/ffffff?text=Smart+Watch' },
                        { id: 'p8', name: 'Ergonomic Mouse', price: 16.50, img: 'https://placehold.co/150x150/191970/ffffff?text=Mouse' },
                        { id: 'p9', name: 'Bamboo Cutting Board', price: 13.95, img: 'https://placehold.co/150x150/8B4513/ffffff?text=Board' },
                        { id: 'p10', name: 'Fitness Resistance Bands Set', price: 11.99, img: 'https://placehold.co/150x150/DC143C/ffffff?text=Bands' },
                    ],
                    cart: {}, 
                    checkoutDetails: null, 
                    invoice: null, 
                    reviews: this.getDefaultReviews(), 
                };

                this.db = null;
                this.auth = null;
                this.unsubscribeReviews = null;

                this.changeView = this.changeView.bind(this);
                this.handleSignIn = this.handleSignIn.bind(this);
                this.handleSignOut = this.handleSignOut.bind(this);
                this.addToCart = this.addToCart.bind(this);
                this.updateCartItem = this.updateCartItem.bind(this);
                this.startCheckout = this.startCheckout.bind(this);
                this.changeCurrency = this.changeCurrency.bind(this);
                this.submitReview = this.submitReview.bind(this);

                this.initFirebase(firebaseConfig, initialAuthToken);
            }
            
            getDefaultReviews() {
                return [
                    { id: 1, user: "Raja S.", rating: 5, text: "The Vintage T-Shirt quality is exceptional! Fast delivery and great customer service. Highly recommend DPD Solutions." },
                    { id: 2, user: "Aditya V.", rating: 4, text: "The Minimalist Mug is exactly as pictured. A slight delay in shipping, but the product itself is perfect." },
                    { id: 3, user: "Rafael V.", rating: 5, text: "Best leather wallet I've owned. Premium feel and very durable. Great value for money." },
                    { id: 4, user: "Divya K.", rating: 3, text: "The Tote Bag is okay, but the material is thinner than expected. Good for light shopping." },
                    { id: 5, user: "Gowtham P.", rating: 5, text: "Five stars! Seamless checkout process and the product tracking was spot on." },
                    { id: 6, user: "Priya M.", rating: 4, text: "Love my new T-Shirt. Fits perfectly. Wish there were more color options available." },
                    { id: 7, user: "Karan B.", rating: 5, text: "Amazing customer support when I had a question about my order. Top-notch service!" },
                    { id: 8, user: "Sunil L.", rating: 4, text: "Solid mug, great price. Arrived well-packaged and intact. Will buy from DPD Solutions again." },
                    { id: 9, user: "Anjali D.", rating: 5, text: "The wallet is worth every penny. Elegant design and practical size." },
                    { id: 10, user: "Bharat T.", rating: 3, text: "Decent product selection, but the website navigation could be smoother. Overall, a good experience." },
                ];
            }


            
            async initFirebase(config, token) {
                if (Object.keys(config).length === 0) {
                    this.state.isAuthReady = true;
                    this.renderApp();
                    return;
                }

                try {
                    const app = initializeApp(config);
                    this.db = getFirestore(app);
                    this.auth = getAuth(app);
                    this.isPersistent = true;

                    if (token) {
                        await signInWithCustomToken(this.auth, token);
                    } else {
                        await signInAnonymously(this.auth);
                    }

                    onAuthStateChanged(this.auth, (user) => {
                        this.state.userId = user ? user.uid : null;
                        this.state.isAuthReady = true;
                        
                        if (this.state.userId && this.state.currentView !== 'signIn') {
                            this.setupDataListeners();
                        }
                        this.renderApp(); 
                    });

                } catch (error) {
                    console.error("Error establishing persistent connection:", error);
                    this.showMessage("Failed to establish persistent connection.", true);
                    this.state.isAuthReady = true;
                    this.isPersistent = false; 
                    this.renderApp();
                }
            }


            setupDataListeners() {
                if (!this.isPersistent || !this.db || !this.state.userId) return;

                const cartRef = this.getCartDocRef();
                onSnapshot(cartRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.state.cart = data.items || {};
                        this.state.checkoutDetails = data.checkoutDetails || null;
                        this.state.invoice = data.invoice || null;
                    } else {
                        this.state.cart = {}; 
                        setDoc(cartRef, { items: {}, createdAt: new Date() }, { merge: true }).catch(err => console.error("Error setting initial cart:", err));
                    }
                    this.renderApp(); 
                }, (error) => {
                    console.error("Error listening to cart:", error);
                });

                const reviewsCol = this.getReviewsCollectionRef();
                const q = query(reviewsCol);
                this.unsubscribeReviews = onSnapshot(q, (snapshot) => {
                    const firestoreReviews = [];
                    snapshot.forEach(doc => {
                        firestoreReviews.push({ id: doc.id, ...doc.data() });
                    });
                    const existingIds = new Set(this.getDefaultReviews().map(r => r.user));
                    const combinedReviews = [...this.getDefaultReviews(), ...firestoreReviews.filter(r => !existingIds.has(r.user))];
                    this.state.reviews = combinedReviews.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    this.renderApp();
                }, (error) => {
                    console.error("Error listening to reviews:", error);
                });
            }

            async updateCartState(newCart) {
                this.state.cart = newCart; 

                if (!this.isPersistent) {
                    this.renderApp(); 
                    return;
                }
                
                try {
                    const cartRef = this.getCartDocRef();
                    if (cartRef) {
                         await updateDoc(cartRef, { items: newCart, updatedAt: new Date() });
                    }
                } catch (error) {
                    console.error("Error updating cart:", error);
                    this.showMessage("Failed to update cart persistently. Check console.", true);
                }
            }
            

            getCartDocRef() {
                if (!this.db || !this.state.userId) return null;
                return doc(this.db, 'artifacts', this.appId, 'users', this.state.userId, 'cartItems', 'currentCart');
            }
            
            getReviewsCollectionRef() {
                if (!this.db) return null;
                return collection(this.db, 'artifacts', this.appId, 'public', 'data', 'reviews');
            }


            showMessage(msg, isError = false) {
                const messageBox = document.getElementById('messageBox');
                if (!messageBox) return; 

                messageBox.textContent = msg;
                messageBox.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-xl transition-opacity duration-300 z-50 ${isError ? 'bg-red-600' : 'accent-green'} text-white opacity-100`;

                clearTimeout(messageBox.timer);
                messageBox.timer = setTimeout(() => {
                    messageBox.classList.remove('opacity-100');
                    messageBox.classList.add('opacity-0');
                    setTimeout(() => {
                        messageBox.classList.add('hidden');
                    }, 300);
                }, 4000);
            }
            
            formatCurrency(amountUSD) {
                const currency = this.CURRENCIES[this.state.selectedCurrency];
                const convertedAmount = amountUSD * currency.rate;
                return `${currency.symbol}${convertedAmount.toFixed(2)}`;
            }
            
            changeCurrency(newCurrency) {
                this.state.selectedCurrency = newCurrency;
                this.showMessage(`Currency changed to ${this.CURRENCIES[newCurrency].name}.`);
                this.renderApp();
            }

            
            changeView(newView) {
                this.state.currentView = newView;
                this.renderApp();
            }

            handleSignIn(details) {
                if (!this.state.isAuthReady) {
                     this.showMessage("Service is initializing. Please wait.", true);
                     return;
                }
                this.showMessage(`Account created for ${details.name}. Redirecting to Home...`);
                this.state.currentView = 'home';
                if (this.isPersistent) this.setupDataListeners();
                this.renderApp();
            }

            handleSignOut() {
                this.state.currentView = 'signIn';
                this.state.cart = {};
                this.state.checkoutDetails = null;
                this.state.invoice = null;
                if (this.unsubscribeReviews) this.unsubscribeReviews();
                this.renderApp();
                this.showMessage("You have been signed out.");
            }

            async addToCart(productId) {
                const product = this.state.products.find(p => p.id === productId);
                if (!product) return this.showMessage("Product not found.", true);

                const newCart = { ...this.state.cart };
                const currentQty = newCart[productId] ? newCart[productId].qty : 0;

                if (currentQty >= this.MAX_QTY) {
                    this.showMessage(`Maximum quantity of ${this.MAX_QTY} reached for ${product.name}.`, true);
                    return;
                }

                newCart[productId] = {
                    name: product.name,
                    price: product.price, 
                    qty: currentQty + 1,
                };
                
                await this.updateCartState(newCart);
                this.showMessage(`${product.name} added to cart!`);
            }
            
            async updateCartItem(productId, newQty) {
                const qty = parseInt(newQty);
                if (isNaN(qty) || qty < 0 || qty > this.MAX_QTY) {
                    this.showMessage(`Quantity must be between 1 and ${this.MAX_QTY}.`, true);
                    return;
                }

                const newCart = { ...this.state.cart };

                if (qty === 0) {
                    delete newCart[productId];
                } else {
                    if (newCart[productId]) {
                        newCart[productId].qty = qty;
                    } else {
                        const product = this.state.products.find(p => p.id === productId);
                        if (product) newCart[productId] = { name: product.name, price: product.price, qty: qty };
                    }
                }

                await this.updateCartState(newCart);
            }

            startCheckout() {
                const totalItems = Object.values(this.state.cart).reduce((sum, item) => sum + item.qty, 0);
                if (totalItems === 0) {
                    this.showMessage("Your cart is empty. Please add items first.", true);
                    return;
                }
                this.state.currentView = 'checkout';
                this.renderApp();
            }

            async completeOrder(details) {
                const targetCurrency = this.CURRENCIES[this.state.selectedCurrency];

                const orderItems = Object.values(this.state.cart).map(item => ({
                    ...item,
                    price: (item.price * targetCurrency.rate).toFixed(2), 
                }));
                
                const subtotalUSD = Object.values(this.state.cart).reduce((sum, item) => sum + (item.price * item.qty), 0);
                const subtotal = subtotalUSD * targetCurrency.rate;
                const taxRate = 0.08;
                const tax = subtotal * taxRate;
                const total = subtotal + tax;

                const newInvoice = {
                    orderId: 'DPD-' + Date.now().toString().slice(-6),
                    date: new Date().toISOString(),
                    currency: this.state.selectedCurrency,
                    items: orderItems,
                    subtotal: subtotal.toFixed(2),
                    tax: tax.toFixed(2),
                    total: total.toFixed(2),
                    details: details
                };
                
                if (!this.isPersistent) {
                    this.state.invoice = newInvoice;
                    this.state.checkoutDetails = details;
                    this.state.cart = {}; 
                    this.state.currentView = 'invoice';
                    this.renderApp();
                    this.showMessage("Order completed successfully!");
                    return;
                }
                
                try {
                    const cartRef = this.getCartDocRef();
                    await runTransaction(this.db, async (transaction) => {
                        transaction.update(cartRef, { 
                            items: {}, 
                            invoice: newInvoice, 
                            checkoutDetails: details 
                        });
                    });

                    this.state.invoice = newInvoice;
                    this.state.checkoutDetails = details;
                    this.state.cart = {};
                    this.state.currentView = 'invoice';
                    this.renderApp();
                    this.showMessage("Order completed successfully!");

                } catch (error) {
                    console.error("Transaction failed during order completion:", error);
                    this.showMessage("Failed to complete order. Please try again.", true);
                }
            }
            
            async submitReview(userName, reviewText, rating) {
                if (!userName || !reviewText || !rating) {
                    return this.showMessage("Please fill out your name, rating, and review text.", true);
                }

                const newReview = {
                    user: userName,
                    text: reviewText,
                    rating: parseInt(rating),
                    timestamp: new Date().toISOString()
                };

                if (!this.isPersistent) {
                    this.state.reviews = [newReview, ...this.state.reviews];
                    this.showMessage("Review posted successfully.");
                    this.renderApp();
                    return;
                }

                try {
                    await addDoc(this.getReviewsCollectionRef(), newReview);
                    this.showMessage("Review posted successfully!");
                } catch (error) {
                    console.error("Error posting review:", error);
                    this.showMessage("Failed to post review. Check console.", true);
                }
            }

            
            renderNavbar(currentPath) {
                const cartItemCount = Object.values(this.state.cart).reduce((sum, item) => sum + item.qty, 0);
                const navLinks = [
                    { id: 'home', text: 'Home' },
                    { id: 'about', text: 'About Us' },
                    { id: 'reviews', text: 'Reviews' },
                ];
                
                const currencyOptions = Object.keys(this.CURRENCIES).map(key => `
                    <option value="${key}" ${this.state.selectedCurrency === key ? 'selected' : ''}>
                        ${key} (${this.CURRENCIES[key].symbol})
                    </option>
                `).join('');

                const navItems = navLinks.map(link => `
                    <button onclick="window.appManager.changeView('${link.id}')" 
                            class="px-3 py-2 rounded-md text-sm font-medium transition duration-150 
                            ${currentPath === link.id ? 'bg-white text-primary-blue shadow-sm' : 'text-gray-100 hover:bg-primary-blue/80'}">
                        ${link.text}
                    </button>
                `).join('');

                return `
                    <header class="w-full primary-blue shadow-lg no-print sticky top-0 z-20">
                        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex justify-between items-center h-16">
                                <span class="text-3xl font-extrabold text-white cursor-pointer" onclick="window.appManager.changeView('home')">DPD<span class="text-primary-orange">Solutions</span></span>
                                <div class="hidden md:flex space-x-4">
                                    ${navItems}
                                </div>
                                <div class="flex items-center space-x-4">
                                    
                                    <!-- Currency Dropdown -->
                                    <div class="relative">
                                        <select onchange="window.appManager.changeCurrency(this.value)" class="text-sm bg-white text-gray-700 py-1.5 pl-3 pr-8 rounded-lg shadow-inner appearance-none cursor-pointer border border-gray-300">
                                            ${currencyOptions}
                                        </select>
                                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                        </div>
                                    </div>
                                    
                                    <!-- Cart Button -->
                                    <button onclick="window.appManager.startCheckout()" class="relative p-2 rounded-full bg-white text-primary-blue hover:bg-gray-100 transition shadow-md">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                        ${cartItemCount > 0 ? `<span class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">${cartItemCount}</span>` : ''}
                                    </button>
                                    
                                    <!-- Sign Out Button -->
                                    <button onclick="window.appManager.handleSignOut()" class="bg-primary-orange text-white hover:bg-orange-600 px-3 py-1.5 text-sm font-medium rounded-lg transition duration-150 shadow-md">
                                        Sign Out
                                    </button>
                                </div>
                            </div>
                        </nav>
                    </header>
                `;
            }

            renderSignIn() {
                const content = `
                    <div id="signInView" class="w-full max-w-lg bg-white p-8 md:p-10 rounded-xl shadow-2xl my-8 border-t-8 border-primary-blue">
                        <h2 class="text-4xl font-extrabold text-gray-900 text-center mb-2">Create Your Account</h2>
                        <p class="text-center text-sm text-gray-500 mb-8">
                            Join DPD Solutions today to enjoy fast, seamless shopping.
                        </p>
                        <form id="signUpForm" class="space-y-4">
                            <div>
                                <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                <input type="text" id="name" required placeholder="John Doe" value="Piruthiviraj" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue">
                            </div>
                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                                <input type="tel" id="phone" required placeholder="9876543210" value="9876543210" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue">
                            </div>
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                                <input type="email" id="email" required placeholder="user@dpdsolutions.com" value="user@dpdsolutions.com" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue">
                            </div>
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="password" required value="password123" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue">
                            </div>
                            <div>
                                <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                                <input type="password" id="confirmPassword" required value="password123" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-bold text-white primary-blue hover:bg-primary-blue/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue transition duration-150 mt-6">
                                Create Account
                            </button>
                        </form>
                    </div>
                `;
                const appRoot = document.getElementById('app');
                appRoot.className = "flex-grow flex flex-col items-center justify-center min-h-screen w-full px-4";
                appRoot.innerHTML = content;

                document.getElementById('signUpForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const password = document.getElementById('password').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    if (password !== confirmPassword) {
                        this.showMessage("Passwords do not match.", true);
                        return;
                    }
                    
                    const details = {
                        name: document.getElementById('name').value,
                        phone: document.getElementById('phone').value,
                        email: document.getElementById('email').value,
                    };
                    this.handleSignIn(details);
                });
            }

            renderHome() {
                const productCards = this.state.products.map(p => {
                    const currentQty = this.state.cart[p.id]?.qty || 0;
                    const canAdd = currentQty < this.MAX_QTY;
                    return `
                        <div class="bg-white rounded-xl shadow-lg flex flex-col items-center p-6 transition duration-300 hover:shadow-2xl hover:scale-[1.02] border border-gray-100">
                            <img src="${p.img}" alt="${p.name}" class="w-32 h-32 object-cover rounded-md mb-4 shadow-md" onerror="this.onerror=null; this.src='https://placehold.co/150x150/fca5a5/ef4444?text=Item';">
                            <h3 class="text-lg font-semibold text-gray-900 text-center">${p.name}</h3>
                            <p class="text-2xl font-extrabold text-green-700 my-2">${this.formatCurrency(p.price)}</p>
                            <p class="text-sm text-gray-500 mb-4">In Cart: <span class="font-bold">${currentQty}</span> / Max: ${this.MAX_QTY}</p>
                            <button onclick="window.appManager.addToCart('${p.id}')" 
                                class="w-full py-2 rounded-lg font-bold text-white transition duration-150 shadow-md flex items-center justify-center space-x-2
                                ${canAdd ? 'accent-green hover:bg-accent-green/90' : 'bg-gray-400 text-gray-700 cursor-not-allowed'}"
                                ${canAdd ? '' : 'disabled'}>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                                <span>Add to Cart</span>
                            </button>
                        </div>
                    `;
                }).join('');

                const currentTitle = this.state.currentView === 'home' 
                    ? 'Welcome to DPD Solutions' 
                    : this.state.currentView === 'about'
                        ? 'About Our Team' 
                        : 'Customer Reviews';

                const mainContent = (() => {
                    switch (this.state.currentView) {
                        case 'home':
                            return `
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-8">
                                    ${productCards}
                                </div>
                            `;
                        case 'about':
                            return `
                                <div class="bg-white p-8 rounded-xl shadow-xl border-t-4 border-primary-blue max-w-3xl mx-auto">
                                    <h2 class="text-2xl font-bold text-gray-800 mb-4">DPD Solutions</h2>
                                    <p class="text-gray-600 mb-6">The main goal of DPD Journals is to promote and support the production of original intellectual works through the process of peer review, while providing authors with a way to professionally validate their research through the publication of high-quality, impactful journals. DPD Journals uses a multi-tiered peer review process System which is double-blind and optimised for speed, using DPD proprietary AI workflow technology, to ensure selective acceptance of all submitted articles and ensuring that authors will receive the highest quality and most original contributions available in the marketplace today.

As a publisher, DPD has developed the Digital Publishing Model which allows for authors' articles to be published digitally, using what is known as the Continuously Published Digital format of Article in Press, allowing for the shortest time frame to move from acceptance to visibility of an article. Additionally, DPD has built a digital platform called DPD Connect, which enhances the digital publishing process through the integration of advanced linking and metadata technologies, as well as providing researchers with the ability to search the DPD Journals using semantic search methods. As a result of these developments, DPD provides researchers from around the world with a flexible Open Access publishing policy focused on equity. DPD's long-term goals are to connect academic institutions with technical standards and the systematic review process to professional licensing boards, research and development departments, and strategic development companies. DPD will measure the impact of articles published in the DPD Journals using DPD's proprietary DPD-Impact Score.</p>
                                    
                                    <h3 class="text-xl font-semibold text-primary-blue mb-3">Development Team Members:</h3>
                                    <ul class="list-disc list-inside space-y-2 text-gray-700 ml-4">
                                        <li><b>Piruthiviraj Saravanan (20221cse0268)</b></li>
                                        <li><b>Vanka Revanth Adithya (20221cse0260)</b></li>
                                        <li><b>Rafael V (20221cse0270)</b></li>
                                    </ul>
                                    <p class="mt-6 text-sm text-gray-500 italic">"Delivering Professional Digital Solutions."</p>
                                </div>
                            `;
                        case 'reviews':
                            return '';
                        default:
                            return '';
                    }
                })();


                const content = `
                    ${this.renderNavbar(this.state.currentView)}
                    <main class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 flex-grow">
                        <h1 class="text-4xl font-extrabold text-gray-900 mb-8 text-center border-b pb-4">
                            ${currentTitle}
                        </h1>
                        ${mainContent}
                        ${this.state.currentView === 'reviews' ? this.renderReviews() : ''}
                    </main>
                `;
                const appRoot = document.getElementById('app');
                appRoot.className = "flex-grow flex flex-col items-center w-full"; 
                appRoot.innerHTML = content;
                
                if (this.state.currentView === 'reviews') this.setupReviewFormListener();
            }
            
            setupReviewFormListener() {
                 document.getElementById('reviewForm')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('reviewName').value;
                    const text = document.getElementById('reviewText').value;
                    const rating = document.getElementById('reviewRating').value;
                    this.submitReview(name, text, rating);
                    
                    document.getElementById('reviewText').value = '';
                    document.getElementById('reviewRating').value = '5';
                });
            }

            renderStarRating(rating) {
                const fullStar = `<svg class="w-5 h-5 text-primary-orange fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`;
                const emptyStar = `<svg class="w-5 h-5 text-gray-300 fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`;
                
                let stars = '';
                for(let i = 1; i <= 5; i++) {
                    stars += i <= rating ? fullStar : emptyStar;
                }
                return `<div class="flex">${stars}</div>`;
            }

            renderReviews() {
                const reviewsList = this.state.reviews.map(review => {
                    const date = review.timestamp ? new Date(review.timestamp).toLocaleDateString() : 'N/A';
                    return `
                        <div class="p-5 bg-gray-50 rounded-lg shadow-inner border border-gray-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-gray-800">${review.user}</span>
                                <span class="text-sm text-gray-500">${date}</span>
                            </div>
                            <div class="mb-3">
                                ${this.renderStarRating(review.rating)}
                            </div>
                            <p class="text-gray-700">${review.text}</p>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
                        
                        <!-- Review Submission Form -->
                        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-2xl border-t-4 border-primary-blue h-fit">
                            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Post Your Review</h2>
                            <form id="reviewForm" class="space-y-4">
                                <div>
                                    <label for="reviewName" class="block text-sm font-medium text-gray-700">Your Name</label>
                                    <input type="text" id="reviewName" required placeholder="Guest" value="Anonymous" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue">
                                </div>
                                <div>
                                    <label for="reviewRating" class="block text-sm font-medium text-gray-700">Rating</label>
                                    <select id="reviewRating" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue appearance-none">
                                        <option value="5">5 - Excellent</option>
                                        <option value="4">4 - Very Good</option>
                                        <option value="3">3 - Average</option>
                                        <option value="2">2 - Poor</option>
                                        <option value="1">1 - Terrible</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="reviewText" class="block text-sm font-medium text-gray-700">Review</label>
                                    <textarea id="reviewText" required rows="4" placeholder="Share your experience..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue"></textarea>
                                </div>
                                <button type="submit" class="w-full py-3 px-4 rounded-lg shadow-md font-bold text-white primary-blue hover:bg-primary-blue/80 transition duration-150">
                                    Submit Review
                                </button>
                            </form>
                        </div>

                        <!-- Existing Reviews List -->
                        <div class="lg:col-span-2 space-y-6">
                            <h2 class="text-2xl font-semibold text-gray-800">Recent Customer Feedback (${this.state.reviews.length})</h2>
                            ${reviewsList}
                        </div>
                    </div>
                `;
            }

            renderCheckout() {
                const targetCurrency = this.CURRENCIES[this.state.selectedCurrency];

                const cartItems = Object.keys(this.state.cart).map(id => ({ id, ...this.state.cart[id] }));
                
                if (cartItems.length === 0) {
                    this.state.currentView = 'home';
                    this.showMessage("Your cart is empty. Redirecting to home.", true);
                    this.renderApp();
                    return;
                }
                
                const subtotalUSD = cartItems.reduce((sum, item) => sum + (item.price * item.qty), 0);
                const subtotal = subtotalUSD * targetCurrency.rate;
                const taxRate = 0.08;
                const tax = subtotal * taxRate;
                const total = subtotal + tax;

                const cartDetails = cartItems.map(item => `
                    <div class="flex justify-between items-center py-3 border-b">
                        <div class="flex flex-col">
                            <span class="font-medium text-gray-800">${item.name}</span>
                            <span class="text-sm text-gray-500">
                                Unit Price: ${this.formatCurrency(item.price)}
                            </span>
                            <span class="text-sm text-gray-500">
                                Qty: 
                                <input type="number" min="0" max="${this.MAX_QTY}" value="${item.qty}" 
                                    class="w-12 text-center border rounded-md focus:ring-primary-blue focus:border-primary-blue transition duration-100" 
                                    onchange="window.appManager.updateCartItem('${item.id}', this.value)">
                            </span>
                        </div>
                        <span class="font-bold text-lg text-primary-blue">${this.formatCurrency(item.price * item.qty)}</span>
                    </div>
                `).join('');


                const content = `
                    ${this.renderNavbar('checkout')}
                    <main class="w-full max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-10 flex-grow">
                        <h1 class="text-4xl font-bold text-gray-800 mb-8 text-center">Secure Checkout</h1>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            
                            <!-- Cart Summary -->
                            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-2xl border-t-4 border-primary-blue order-2 lg:order-1 h-fit">
                                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Order Summary</h2>
                                <p class="text-xs text-red-500 mb-4">Prices shown in ${targetCurrency.name} (${targetCurrency.symbol}).</p>
                                <div class="space-y-2">
                                    ${cartDetails}
                                </div>
                                
                                <div class="mt-6 pt-4 border-t border-gray-200 space-y-2">
                                    <div class="flex justify-between text-gray-600"><span>Subtotal</span><span>${targetCurrency.symbol}${subtotal.toFixed(2)}</span></div>
                                    <div class="flex justify-between text-gray-600"><span>Tax (8%)</span><span>${targetCurrency.symbol}${tax.toFixed(2)}</span></div>
                                    <div class="flex justify-between text-xl font-bold text-gray-900 pt-2 border-t mt-2"><span>Order Total</span><span>${targetCurrency.symbol}${total.toFixed(2)}</span></div>
                                </div>
                            </div>

                            <!-- Checkout Form -->
                            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-2xl order-1 lg:order-2">
                                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Shipping & Payment</h2>
                                <form id="checkoutForm" class="space-y-6">
                                    <div>
                                        <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                        <input type="text" id="name" required placeholder="John Doe" value="Piruthiviraj S." class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue">
                                    </div>
                                    <div>
                                        <label for="address" class="block text-sm font-medium text-gray-700">Shipping Address</label>
                                        <textarea id="address" required placeholder="123 Main St, Anytown, USA" rows="3" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue">Chennai, Tamil Nadu, India</textarea>
                                    </div>

                                    <div class="space-y-4">
                                        <p class="block text-sm font-medium text-gray-700">Payment Method</p>
                                        <div class="flex flex-wrap gap-4">
                                            <label class="flex items-center p-3 border rounded-lg shadow-sm cursor-pointer hover:bg-gray-50">
                                                <input type="radio" name="paymentMethod" value="Card" checked class="form-radio text-primary-blue h-5 w-5">
                                                <span class="ml-2 text-gray-700 font-medium">Credit Card</span>
                                            </label>
                                            <label class="flex items-center p-3 border rounded-lg shadow-sm cursor-pointer hover:bg-gray-50">
                                                <input type="radio" name="paymentMethod" value="PayPal" class="form-radio text-primary-blue h-5 w-5">
                                                <span class="ml-2 text-gray-700 font-medium">PayPal</span>
                                            </label>
                                            <label class="flex items-center p-3 border rounded-lg shadow-sm cursor-pointer hover:bg-gray-50">
                                                <input type="radio" name="paymentMethod" value="Cash" class="form-radio text-primary-blue h-5 w-5">
                                                <span class="ml-2 text-gray-700 font-medium">Cash on Delivery</span>
                                            </label>
                                        </div>
                                        <p class="text-xs text-red-500">Note: Payment details are securely processed but no live transaction is initiated.</p>
                                    </div>

                                    <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-lg shadow-lg text-lg font-bold text-white accent-green hover:bg-accent-green/90 transition duration-150">
                                        Place Order - ${targetCurrency.symbol}${total.toFixed(2)}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </main>
                `;
                const appRoot = document.getElementById('app');
                appRoot.className = "flex-grow flex flex-col items-center w-full";
                appRoot.innerHTML = content;

                document.getElementById('checkoutForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('name').value;
                    const address = document.getElementById('address').value;
                    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

                    const details = { name, address, paymentMethod };
                    this.completeOrder(details);
                });
            }

            renderInvoice() {
                if (!this.state.invoice) {
                    this.state.currentView = 'home';
                    this.showMessage("No invoice found. Redirecting to home.", true);
                    this.renderApp();
                    return;
                }

                const invoice = this.state.invoice;
                const currency = this.CURRENCIES[invoice.currency || 'USD'];
                const itemsHtml = invoice.items.map(item => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${item.qty}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${currency.symbol}${item.price}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-right">${currency.symbol}${(parseFloat(item.price) * item.qty).toFixed(2)}</td>
                    </tr>
                `).join('');

                const content = `
                    ${this.renderNavbar('invoice')}
                    <main id="invoiceView" class="w-full max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-10 flex-grow bg-white rounded-xl shadow-2xl my-8">
                        <div class="p-8">
                            <div class="flex justify-between border-b-4 border-primary-blue pb-4 mb-6">
                                <h1 class="text-4xl font-extrabold text-primary-blue">INVOICE</h1>
                                <div class="text-right">
                                    <p class="text-sm text-gray-600">DPD Solutions</p>
                                    <p class="text-sm text-gray-600">Invoice ID: <span class="font-medium">${invoice.orderId}</span></p>
                                    <p class="text-sm text-gray-600">Date: ${new Date(invoice.date).toLocaleDateString()}</p>
                                    <p class="text-sm text-gray-600">Currency: ${currency.name} (${currency.symbol})</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-8 text-sm mb-8">
                                <div>
                                    <h3 class="font-semibold text-gray-700 mb-1">Billed To:</h3>
                                    <p class="font-medium">${invoice.details.name}</p>
                                    <p class="text-gray-500">${invoice.details.address.split('\n').join('<br>')}</p>
                                </div>
                                <div class="text-right">
                                    <h3 class="font-semibold text-gray-700 mb-1">Payment:</h3>
                                    <p class="font-medium">${invoice.details.paymentMethod}</p>
                                    <p class="text-green-600 font-bold">Status: PAID</p>
                                </div>
                            </div>

                            <div class="shadow overflow-hidden border border-gray-200 sm:rounded-lg mb-8">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Item</th>
                                            <th scope="col" class="px-6 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Qty</th>
                                            <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Unit Price</th>
                                            <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${itemsHtml}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Totals -->
                            <div class="flex justify-end">
                                <div class="w-full md:w-1/2 space-y-2">
                                    <div class="flex justify-between text-base text-gray-600"><span>Subtotal</span><span>${currency.symbol}${invoice.subtotal}</span></div>
                                    <div class="flex justify-between text-base text-gray-600"><span>Tax (8%)</span><span>${currency.symbol}${invoice.tax}</span></div>
                                    <div class="flex justify-between text-2xl font-extrabold text-primary-blue border-t-2 pt-2 mt-2"><span>TOTAL</span><span>${currency.symbol}${invoice.total}</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Continue Shopping Button -->
                        <div class="no-print text-center p-6 border-t mt-8">
                            <button onclick="window.appManager.changeView('home')" class="primary-blue text-white py-3 px-6 rounded-lg font-semibold hover:bg-primary-blue/80 transition shadow-lg">
                                Continue Shopping
                            </button>
                        </div>
                    </main>
                `;
                const appRoot = document.getElementById('app');
                appRoot.className = "flex-grow flex flex-col items-center w-full";
                appRoot.innerHTML = content;

                setTimeout(() => window.print(), 100);
            }

            renderApp() {
                if (!this.state.isAuthReady) {
                    return; 
                }

                switch (this.state.currentView) {
                    case 'signIn':
                        this.renderSignIn();
                        break;
                    case 'home':
                    case 'about':
                    case 'reviews':
                        this.renderHome();
                        break;
                    case 'checkout':
                        this.renderCheckout();
                        break;
                    case 'invoice':
                        this.renderInvoice();
                        break;
                    default:
                        this.renderSignIn();
                }
            }
        }

        function initializeAppAndManager() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            let firebaseConfig = {};
            try {
                firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            } catch (e) {
                console.error("Failed to parse firebase config:", e);
            }
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            window.appManager = new AppManager(appId, firebaseConfig, initialAuthToken);
        }

        document.addEventListener('DOMContentLoaded', initializeAppAndManager);
    </script>
</body>
</html>